# ENA-submission-in-R
Scripts under development for submission of amplicon sequence data to the ENA within the R environment.

# Why submit to ENA in R?
Submitting sequences to the ENA is quite an involved process, and it can take time. There are a variety of ways to submit, but I'm unaware of any routines for doing it in R. Since most researchers working on amplicon sequence data are familiar with working in the R environment, it makes sense to have scripts available to submit directly from R.
Personally, I never really know if I'm submitting "correctly", so at least making the code available allows me to reproduce (and hopefully correct) any mistakes. It could potentially be packaged  - contribs and feedback most welcome.

# The functions:
This repostitory contains a set of R functions to faciliate the submission of amplicon sequences, such as paired end fastq files from  Illumina MiSeq sequencing of amplicons generated by marker gene amplification from environmentally extracted DNA. A file containing the functions is [here](https://github.com/robiwangriff/ENA-submission-in-R/blob/main/ena_subm_fxns.R), and a set of example useage scripts is provided [here](https://github.com/robiwangriff/ENA-submission-in-R/blob/main/ena_subm_example.R). The example useage file can be worked through using a provided [environmental metadata file](https://github.com/robiwangriff/ENA-submission-in-R/blob/main/env_metadata.csv), and some small [exemplar fastq files](https://github.com/robiwangriff/ENA-submission-in-R/tree/main/fastq_files_from_sequencer) (16S rRNA gene and ITS assays performed on the same samples). All being well, these scripts should enable a successful submission of the example datasets on the ENA test server, all from within R. They can then be applied to personal datasets, though I strongly suggest that with large numbers of fastq files you use a dedicated file transfer program to upload fastqs to ENA, and do go through the example first.

The functions broadly address the use of R to:

1. Transfer "fastqs relevant to a study" from a sequencing output dir (eg the MiSeq dump) to a local submission dir (eg a project/paper dir), based on samples present in an environmental metadata file.
2. Generating md5 checksums for the fastqs
3. Uploading fastqs to the ENA (though R routines not recomended for large numbers of files)
4. Creating a sample submission dataframe, based on the user provided environmental metadata file, and validating against relevant ENA MixS checklists
5. Linking samples to fastq reads (multiple amplicon assays possible) by constructing ENA EXPERIMENT and RUN files
6. Converting dataframes to xml format required by the ENA for programatic submission
7. Submitting xmls to ENA within R (the example only submits to the dev server for obvious reasons)
8. Populating the environmental metadata file with ENA accession numbers, to enable reproducible coding of subsequent analyses.

# Useage
You will of course need an [ENA account](https://www.ebi.ac.uk/ena/submit/sra/#home) to submit sequences. Clone this repository if you are a github user, or click the green button to download a zipped file. You may need to modify paths in the example file depending on where you put the extracted dir, and possibly your preference for R/Rstudio etc. Then work through the [ena_subm_example.R](https://github.com/robiwangriff/ENA-submission-in-R/blob/main/ena_subm_example.R) file, which loads the functions contained in [ena_subm_fxns.R](https://github.com/robiwangriff/ENA-submission-in-R/blob/main/ena_subm_fxns.R) via a source() command. 

You should get a pretty speedy submission to the ENA dev server using the example files, but be under no illusion. Copying large files even locally takes time, as does the md5 generation - so be prepared to forfeit your R session for a bit whilst things are running with "real" datasets. Some progress bars would be useful. Additionally, since the user decides what data to upload, there is of course some manual work involved in selecting your relevant metadata fields and populating the sample info file according to the MixS checklists. 

After submission of the xmls a receipt is returned indicating whether the submission is succesful. You may get failed test submissions because the project/samples/runs have already been registered (from your previous attempt)...even with the dev server. Though the dev server is supposed to be purged every day, things seem to hang around for a bit and there doesn't appear to be a way of purging it yourself. On the plus side, this may mean your submission attempt to the dev server has kind of worked.

A final note: be careful with real submissions as erroneous ones are hard to come back from, without renaming sample aliases and even your fastq files - hardly reproducible, and a pain. Always test on the dev server before submitting your samples. Dont try and submit anything that may have been submitted before (eg the test files included here!).

Rob 
